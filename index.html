<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simula√ß√£o Interativa de Campo El√©trico (2 Cargas)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        #main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            align-items: flex-start;
        }
        
        /* Estilos do Avatar */
        #avatar-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            overflow: hidden;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        #avatar-header {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #avatar-face {
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        #avatar-name {
            color: white;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        #avatar-body {
            padding: 20px;
            background: white;
            max-height: 250px;
            overflow-y: auto;
        }
        
        #speech-bubble {
            position: relative;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 0.95em;
            line-height: 1.6;
            color: #333;
        }
        
        #speech-bubble:before {
            content: '';
            position: absolute;
            top: -10px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid #f0f0f0;
        }
        
        .typing-indicator {
            display: inline-block;
            animation: blink 1.4s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        #avatar-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .avatar-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        #play-btn {
            background: #4CAF50;
            color: white;
        }
        
        #play-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        #pause-btn {
            background: #ff9800;
            color: white;
        }
        
        #pause-btn:hover {
            background: #e68900;
            transform: scale(1.05);
        }
        
        #restart-btn {
            background: #2196F3;
            color: white;
        }
        
        #restart-btn:hover {
            background: #0b7dda;
            transform: scale(1.05);
        }
        
        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .speaking {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #volume-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #volume-slider {
            flex: 1;
        }
        
        .volume-icon {
            font-size: 1.2em;
        }
        
        #flowchart {
            width: 350px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #flowchart h2 {
            color: #007bff;
            margin-top: 0;
            font-size: 1.3em;
        }
        .flow-step {
            margin: 15px 0;
            padding: 12px;
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .flow-step h3 {
            margin: 0 0 8px 0;
            color: #007bff;
            font-size: 1em;
        }
        .flow-step p {
            margin: 0;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .formula {
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 8px 0;
            font-size: 0.85em;
        }
        .arrow {
            text-align: center;
            color: #007bff;
            font-size: 1.5em;
            margin: 5px 0;
        }
        #simulation-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #controls {
            margin-top: 20px;
            width: 600px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
        }
        .charge-value {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>

    <h1>Simula√ß√£o Interativa de Campo El√©trico</h1>
    <p>Arraste as cargas na tela para mudar a posi√ß√£o e use os controles para alterar a magnitude.</p>

    <!-- Avatar Explicativo -->
    <div id="avatar-container">
        <div id="avatar-header">
            <div id="avatar-face">ü§î</div>
            <div id="avatar-name">Prof. El√©tron</div>
        </div>
        <div id="avatar-body">
            <div id="speech-bubble">
                Ol√°! Clique em "Iniciar" para eu te explicar como funciona esta simula√ß√£o!
            </div>
            <div id="avatar-controls">
                <button id="play-btn" class="avatar-btn">‚ñ∂Ô∏è Iniciar</button>
                <button id="pause-btn" class="avatar-btn" style="display:none;">‚è∏Ô∏è Pausar</button>
                <button id="restart-btn" class="avatar-btn">üîÑ Reiniciar</button>
            </div>
            <div id="volume-control">
                <span class="volume-icon">üîä</span>
                <input type="range" id="volume-slider" min="0" max="100" value="80" title="Volume da narra√ß√£o">
                <span id="volume-value">80%</span>
            </div>
        </div>
    </div>

    <div id="main-container">
        <!-- Fluxograma Did√°tico -->
        <div id="flowchart">
            <h2>üìä Como Funciona a Simula√ß√£o</h2>
            
            <div class="flow-step">
                <h3>1Ô∏è‚É£ Inicializa√ß√£o</h3>
                <p>Sistema cria duas cargas el√©tricas (q1 positiva e q2 negativa) em posi√ß√µes iniciais</p>
            </div>
            
            <div class="arrow">‚Üì</div>
            
            <div class="flow-step">
                <h3>2Ô∏è‚É£ Intera√ß√£o do Usu√°rio</h3>
                <p><strong>Arrastar:</strong> Clique e arraste as cargas para mudar posi√ß√£o</p>
                <p><strong>Sliders:</strong> Ajuste a magnitude das cargas (de -5C a +5C)</p>
            </div>
            
            <div class="arrow">‚Üì</div>
            
            <div class="flow-step">
                <h3>3Ô∏è‚É£ C√°lculo do Campo</h3>
                <p>Para cada ponto da grade (25√ó25 pontos):</p>
                <div class="formula">
                    E‚Éó = Œ£ k¬∑q¬∑R‚Éó / |R‚Éó|¬≥
                </div>
                <p style="font-size: 0.85em; color: #666;">
                    <strong>R‚Éó:</strong> vetor da carga ao ponto<br>
                    <strong>k:</strong> constante de Coulomb<br>
                    <strong>q:</strong> valor da carga
                </p>
            </div>
            
            <div class="arrow">‚Üì</div>
            
            <div class="flow-step">
                <h3>4Ô∏è‚É£ Visualiza√ß√£o</h3>
                <p><strong>Vetores:</strong> Setas mostram dire√ß√£o e intensidade do campo</p>
                <p><strong>Cor das setas:</strong> Mais escuras = campo mais forte</p>
                <p><strong>Cargas:</strong> Vermelho (+) / Azul (-)</p>
            </div>
            
            <div class="arrow">‚Üì</div>
            
            <div class="flow-step">
                <h3>5Ô∏è‚É£ Atualiza√ß√£o Cont√≠nua</h3>
                <p>O sistema recalcula tudo 60 vezes por segundo, criando uma anima√ß√£o fluida e responsiva</p>
            </div>
        </div>

        <!-- Simula√ß√£o e Controles -->
        <div>
            <div id="simulation-container"></div>
            
            <div id="controls">
                <h2>Controles das Cargas</h2>
                
                <div class="control-group">
                    <label for="slider_q1">Carga q1 (C): <span id="q1_display" class="charge-value">1.0</span></label>
                    <input type="range" id="slider_q1" min="-5" max="5" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <label for="slider_q2">Carga q2 (C): <span id="q2_display" class="charge-value">-1.0</span></label>
                    <input type="range" id="slider_q2" min="-5" max="5" step="0.1" value="-1.0">
                </div>
            </div>
        </div>
    </div>
    
    <script>
        
        // ===================================================================================
        // SISTEMA DE AVATAR EXPLICATIVO COM NARRA√á√ÉO POR VOZ
        // ===================================================================================
        
        // Configura√ß√£o de voz
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let voiceVolume = 0.8;
        
        const avatarScript = [
            {
                text: "üëã Ol√°! Eu sou o Professor El√©tron e vou te guiar por esta simula√ß√£o de <span class='highlight'>campo el√©trico</span>!",
                speech: "Ol√°! Eu sou o Professor El√©tron e vou te guiar por esta simula√ß√£o de campo el√©trico!",
                emoji: "ü§î"
            },
            {
                text: "Veja estas duas cargas na tela: a <span class='highlight'>vermelha √© positiva</span> (+) e a <span class='highlight'>azul √© negativa</span> (-). Elas criam um campo el√©trico ao seu redor!",
                speech: "Veja estas duas cargas na tela: a vermelha √© positiva, e a azul √© negativa. Elas criam um campo el√©trico ao seu redor!",
                emoji: "‚ö°"
            },
            {
                text: "As <span class='highlight'>setinhas</span> que voc√™ v√™ representam a dire√ß√£o e intensidade do campo el√©trico em cada ponto do espa√ßo. Quanto mais escuras, mais forte √© o campo!",
                speech: "As setinhas que voc√™ v√™ representam a dire√ß√£o e intensidade do campo el√©trico em cada ponto do espa√ßo. Quanto mais escuras, mais forte √© o campo!",
                emoji: "‚û°Ô∏è"
            },
            {
                text: "Agora tente <span class='highlight'>arrastar uma carga</span> com o mouse! Veja como o campo se reorganiza instantaneamente. A f√≠sica est√° acontecendo em tempo real!",
                speech: "Agora tente arrastar uma carga com o mouse! Veja como o campo se reorganiza instantaneamente. A f√≠sica est√° acontecendo em tempo real!",
                emoji: "üëÜ"
            },
            {
                text: "Use os <span class='highlight'>controles deslizantes</span> abaixo para mudar a magnitude das cargas. Voc√™ pode torn√°-las mais fortes ou at√© inverter seus sinais!",
                speech: "Use os controles deslizantes abaixo para mudar a magnitude das cargas. Voc√™ pode torn√°-las mais fortes ou at√© inverter seus sinais!",
                emoji: "üéöÔ∏è"
            },
            {
                text: "Por tr√°s dos panos, o sistema est√° calculando a <span class='highlight'>Lei de Coulomb</span>: E = k¬∑q¬∑R/|R|¬≥ para cada ponto, 60 vezes por segundo!",
                speech: "Por tr√°s dos panos, o sistema est√° calculando a Lei de Coulomb para cada ponto, 60 vezes por segundo!",
                emoji: "üßÆ"
            },
            {
                text: "Experimente aproximar as cargas ou coloc√°-las com o mesmo sinal. O que acontece com o campo? A f√≠sica √© linda, n√£o √©? üåü",
                speech: "Experimente aproximar as cargas ou coloc√°-las com o mesmo sinal. O que acontece com o campo? A f√≠sica √© linda, n√£o √©?",
                emoji: "üî¨"
            },
            {
                text: "Continue explorando! Use o bot√£o 'Reiniciar' se quiser ouvir a explica√ß√£o novamente. Divirta-se aprendendo! üéì",
                speech: "Continue explorando! Use o bot√£o Reiniciar se quiser ouvir a explica√ß√£o novamente. Divirta-se aprendendo!",
                emoji: "‚ú®"
            }
        ];
        
        let currentStep = 0;
        let isPlaying = false;
        let voicesLoaded = false;
        
        // Fun√ß√£o para selecionar voz masculina em portugu√™s
        function getPortugueseVoice() {
            const voices = speechSynthesis.getVoices();
            
            // Prioriza vozes masculinas em portugu√™s do Brasil
            let voice = voices.find(v => 
                v.lang.includes('pt-BR') && 
                (v.name.includes('Male') || v.name.includes('Masculine') || v.name.includes('Luciano'))
            );
            
            // Se n√£o encontrar masculina, usa qualquer voz em portugu√™s do Brasil
            if (!voice) {
                voice = voices.find(v => v.lang.includes('pt-BR'));
            }
            
            // Se n√£o encontrar pt-BR, usa qualquer portugu√™s
            if (!voice) {
                voice = voices.find(v => v.lang.includes('pt'));
            }
            
            // Se n√£o encontrar nenhuma, usa a padr√£o
            return voice || voices[0];
        }
        
        // Fun√ß√£o para falar o texto e aguardar o t√©rmino + 2 segundos
        function speak(text, callback) {
            // Cancela qualquer fala anterior
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            
            // Cria nova inst√¢ncia de fala
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Configura a voz
            const voice = getPortugueseVoice();
            if (voice) {
                currentUtterance.voice = voice;
            }
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = 0.95;
            currentUtterance.pitch = 0.9;
            currentUtterance.volume = voiceVolume;
            
            // Adiciona anima√ß√£o visual enquanto fala
            const face = document.getElementById('avatar-face');
            
            currentUtterance.onstart = () => {
                face.classList.add('speaking');
            };
            
            currentUtterance.onend = () => {
                face.classList.remove('speaking');
                // Aguarda 2 segundos ap√≥s terminar antes de chamar o callback
                if (callback && isPlaying) {
                    setTimeout(callback, 2000);
                }
            };
            
            currentUtterance.onerror = (event) => {
                console.error('Erro na s√≠ntese de voz:', event);
                face.classList.remove('speaking');
                // Mesmo com erro, continua ap√≥s 2 segundos
                if (callback && isPlaying) {
                    setTimeout(callback, 2000);
                }
            };
            
            // Fala o texto
            speechSynthesis.speak(currentUtterance);
        }
        
        function updateAvatarSpeech(step) {
            if (!isPlaying || step >= avatarScript.length) {
                // Fim da explica√ß√£o
                isPlaying = false;
                document.getElementById('play-btn').style.display = 'inline-block';
                document.getElementById('pause-btn').style.display = 'none';
                return;
            }
            
            const bubble = document.getElementById('speech-bubble');
            const face = document.getElementById('avatar-face');
            const scriptItem = avatarScript[step];
            
            // Atualiza o emoji do avatar
            face.textContent = scriptItem.emoji;
            
            // Efeito de digita√ß√£o
            bubble.innerHTML = '<span class="typing-indicator">Digitando...</span>';
            
            setTimeout(() => {
                bubble.innerHTML = scriptItem.text;
                
                // Narra o texto e, quando terminar (+ 2s), vai para o pr√≥ximo passo
                speak(scriptItem.speech, () => {
                    if (isPlaying) {
                        currentStep++;
                        updateAvatarSpeech(currentStep);
                    }
                });
            }, 500);
        }
        
        function startAvatar() {
            if (!isPlaying) {
                isPlaying = true;
                document.getElementById('play-btn').style.display = 'none';
                document.getElementById('pause-btn').style.display = 'inline-block';
                updateAvatarSpeech(currentStep);
            }
        }
        
        function pauseAvatar() {
            isPlaying = false;
            // Para a narra√ß√£o
            speechSynthesis.cancel();
            document.getElementById('avatar-face').classList.remove('speaking');
            document.getElementById('play-btn').style.display = 'inline-block';
            document.getElementById('pause-btn').style.display = 'none';
        }
        
        function restartAvatar() {
            pauseAvatar();
            currentStep = 0;
            const bubble = document.getElementById('speech-bubble');
            bubble.innerHTML = "Ol√°! Clique em 'Iniciar' para eu te explicar como funciona esta simula√ß√£o!";
            document.getElementById('avatar-face').textContent = "ü§î";
        }
        
        // Controle de volume
        function updateVolume() {
            const slider = document.getElementById('volume-slider');
            voiceVolume = slider.value / 100;
            document.getElementById('volume-value').textContent = slider.value + '%';
            
            // Atualiza volume da narra√ß√£o atual se estiver falando
            if (currentUtterance && speechSynthesis.speaking) {
                // N√£o √© poss√≠vel alterar o volume em tempo real,
                // mas ser√° aplicado na pr√≥xima fala
            }
        }
        
        // Event Listeners do Avatar
        document.addEventListener('DOMContentLoaded', () => {
            // Carrega as vozes dispon√≠veis
            function loadVoices() {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                    console.log('Vozes carregadas:', voices.length);
                }
            }
            
            // Alguns navegadores precisam esperar o evento
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }
            loadVoices(); // Tenta carregar imediatamente tamb√©m
            
            document.getElementById('play-btn').addEventListener('click', startAvatar);
            document.getElementById('pause-btn').addEventListener('click', pauseAvatar);
            document.getElementById('restart-btn').addEventListener('click', restartAvatar);
            document.getElementById('volume-slider').addEventListener('input', updateVolume);
        });
        
        // ===================================================================================
        // VARI√ÅVEIS DE SIMULA√á√ÉO E FUN√á√ïES B√ÅSICAS
        // ===================================================================================
        
        // Constantes e Configura√ß√µes
        const CANVAS_SIZE = 600;
        const GRID_DENSITY = 25;
        const K_COULOMB_SCALE = 5000;
        
        let charges = [];
        let selectedCharge = null;

        // Estrutura de Carga
        class Charge {
            constructor(q, x, y, name) {
                this.q = q;
                this.x = x;
                this.y = y;
                this.name = name;
                this.radius = 15;
            }
        }
        
        // Fun√ß√£o de C√°lculo do Campo El√©trico
        function calculateElectricField(r, charges) {
            let Ex = 0;
            let Ey = 0;

            for (let charge of charges) {
                let Rx = r.x - charge.x;
                let Ry = r.y - charge.y;
                
                let r_squared = Rx * Rx + Ry * Ry;
                
                const MIN_DISTANCE_SQUARED = 100;
                if (r_squared < MIN_DISTANCE_SQUARED) {
                    continue;
                }

                let r_mag_cubed = Math.pow(r_squared, 1.5);
                
                let E_mag_component = K_COULOMB_SCALE * charge.q / r_mag_cubed;

                Ex += E_mag_component * Rx;
                Ey += E_mag_component * Ry;
            }

            return createVector(Ex, Ey);
        }
        
        // ===================================================================================
        // FUN√á√ïES P5.JS (SETUP E LOOP DE DESENHO)
        // ===================================================================================
        
        function setup() {
            let canvas = createCanvas(CANVAS_SIZE, CANVAS_SIZE);
            canvas.parent('simulation-container');
            
            canvas.mousePressed(onMousePressed);
            canvas.mouseReleased(onMouseReleased);

            charges.push(new Charge(1.0, CANVAS_SIZE * 0.3, CANVAS_SIZE * 0.5, "q1"));
            charges.push(new Charge(-1.0, CANVAS_SIZE * 0.7, CANVAS_SIZE * 0.5, "q2"));

            document.getElementById('slider_q1').oninput = updateChargeQ;
            document.getElementById('slider_q2').oninput = updateChargeQ;
            
            updateChargeQ();
            
            console.log("Setup da Simula√ß√£o conclu√≠do.");
        }

        function draw() {
            background(255);

            if (selectedCharge) {
                selectedCharge.x = mouseX;
                selectedCharge.y = mouseY;
            }
            
            drawElectricField();
            drawCharges();
        }

        function drawElectricField() {
            let sameSign = (charges[0].q * charges[1].q) > 0;
            
            for (let i = 0; i < GRID_DENSITY; i++) {
                for (let j = 0; j < GRID_DENSITY; j++) {
                    let x = map(i, 0, GRID_DENSITY - 1, 0, CANVAS_SIZE);
                    let y = map(j, 0, GRID_DENSITY - 1, 0, CANVAS_SIZE);
                    
                    if (sameSign) {
                        let midX = (charges[0].x + charges[1].x) / 2;
                        let midY = (charges[0].y + charges[1].y) / 2;
                        let distToMid = dist(x, y, midX, midY);
                        let chargesDistance = dist(charges[0].x, charges[0].y, charges[1].x, charges[1].y);
                        
                        if (distToMid < chargesDistance * 0.15) {
                            continue;
                        }
                    }
                    
                    let r = createVector(x, y);
                    let E = calculateElectricField(r, charges);
                    
                    let E_mag = E.mag();

                    let color_scale = map(E_mag, 0, 5, 0, 255); 
                    stroke(color_scale, 150); 
                    
                    E.normalize();
                    let arrow_length = 20;

                    push();
                    translate(x, y);
                    rotate(E.heading());
                    line(0, 0, arrow_length, 0);
                    line(arrow_length, 0, arrow_length - 5, -3);
                    line(arrow_length, 0, arrow_length - 5, 3);
                    pop();
                }
            }
        }
        
        function drawCharges() {
            for (let charge of charges) {
                if (charge.q > 0) {
                    fill(255, 0, 0, 200);
                } else if (charge.q < 0) {
                    fill(0, 0, 255, 200);
                } else {
                    fill(150);
                }
                
                charge.radius = 10 + 5 * Math.abs(charge.q);

                noStroke();
                ellipse(charge.x, charge.y, charge.radius * 2);

                fill(255);
                textAlign(CENTER, CENTER);
                textSize(12);
                text(charge.name, charge.x, charge.y - 5);
                text(charge.q.toFixed(1), charge.x, charge.y + 10);
            }
        }

        // ===================================================================================
        // FUN√á√ïES DE INTERATIVIDADE (Callbacks)
        // ===================================================================================

        function onMousePressed() {
            for (let charge of charges) {
                let d = dist(mouseX, mouseY, charge.x, charge.y);
                if (d < charge.radius) {
                    selectedCharge = charge;
                    break;
                }
            }
        }

        function onMouseReleased() {
            selectedCharge = null;
        }

        function updateChargeQ() {
            const slider1 = document.getElementById('slider_q1');
            const slider2 = document.getElementById('slider_q2');
            
            charges[0].q = parseFloat(slider1.value);
            charges[1].q = parseFloat(slider2.value);

            document.getElementById('q1_display').innerText = charges[0].q.toFixed(1);
            document.getElementById('q2_display').innerText = charges[1].q.toFixed(1);
        }

    </script>
</body>
</html>
